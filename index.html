<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift-Sight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: pan 90s linear infinite;
        }
        @keyframes pan { from { background-position: 0 0; } to { background-position: -400px -400px; } }
        #table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        #table-container::-webkit-scrollbar-track { background: #0f172a; }
        #table-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .tab-btn.active { border-color: #3b82f6; color: #3b82f6; }
        .gradient-text { background: linear-gradient(to right, #22d3ee, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .dashboard-filter-btn { cursor: pointer; transition: color 0.2s; font-weight: 700; }
        .dashboard-filter-btn:hover { color: #60a5fa; text-decoration: underline; }
    </style>
</head>
<body class="text-slate-300 flex flex-col min-h-screen">

    <main class="flex-grow flex items-center justify-center p-4">
        <!-- Homepage View -->
        <div id="homepage-view" class="text-center max-w-2xl w-full">
            <h1 class="text-6xl font-black tracking-tight gradient-text mb-2">SHIFT-SIGHT</h1>
            <p class="text-slate-400 text-lg mb-10">2026 Ready Roster Analyzer.</p>
            <div id="drop-zone" class="bg-slate-800/50 border-2 border-dashed border-slate-700 rounded-2xl p-10 cursor-pointer hover:border-blue-500 hover:bg-slate-800 transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <h2 class="mt-4 text-xl font-semibold text-slate-200">Upload Data</h2>
                <p class="mt-1 text-sm text-slate-500">Drag & drop your .xlsx file here</p>
                <input id="file-upload" type="file" accept=".xlsx, .xls" class="hidden"/>
            </div>
             <p id="homepage-error" class="text-red-400 text-sm mt-4"></p>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden max-w-7xl w-full mx-auto bg-slate-900/70 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 sm:p-8">
            <div class="border-b border-slate-700 pb-4 mb-6">
                <h1 id="dashboard-title" class="text-2xl sm:text-3xl font-bold text-slate-100 gradient-text">Shift-Sight</h1>
            </div>
            
            <div id="roster-dashboard" class="hidden mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-200">Daily Roster</h2>
                    <div class="flex items-center gap-2 mt-2 sm:mt-0">
                        <label for="roster-date-select" class="text-sm font-medium">Select Date:</label>
                        <select id="roster-date-select" class="p-2 bg-slate-700 border border-slate-600 rounded-lg text-sm"></select>
                    </div>
                </div>
                <div id="roster-content" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-slate-800/50 p-4 rounded-lg border border-blue-500/30">
                        <h3 class="font-bold text-blue-300 mb-2">Shift A (07:00-16:00)</h3>
                        <div id="shift-a-summary" class="text-slate-400 text-sm"></div>
                    </div>
                    <div class="bg-slate-800/50 p-4 rounded-lg border border-green-500/30">
                         <h3 class="font-bold text-green-300 mb-2">Shift B (13:00-22:00)</h3>
                         <div id="shift-b-summary" class="text-slate-400 text-sm"></div>
                    </div>
                    <div class="bg-slate-800/50 p-4 rounded-lg border border-amber-500/30">
                         <h3 class="font-bold text-amber-300 mb-2">Shift C (22:00-07:00)</h3>
                         <div id="shift-c-summary" class="text-slate-400 text-sm"></div>
                    </div>
                </div>
            </div>

            <div id="legend" class="hidden mb-6 p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                 <div class="flex flex-wrap gap-4 items-center text-[11px] font-bold">
                     <span class="px-2 py-1 rounded bg-blue-500/20 text-blue-400">A: 07:00-16:00</span>
                     <span class="px-2 py-1 rounded bg-green-500/20 text-green-400">B: 13:00-22:00</span>
                     <span class="px-2 py-1 rounded bg-amber-500/20 text-amber-400">C: 22:00-07:00</span>
                     <span class="px-2 py-1 rounded bg-slate-700 text-slate-300">W/O: Week-Off</span>
                 </div>
            </div>

            <div id="tabs-section" class="hidden mb-4 border-b border-slate-700">
                <nav class="-mb-px flex space-x-6">
                    <button id="all-tab" data-view="all" class="tab-btn active py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200">All</button>
                    <button id="male-tab" data-view="male" class="tab-btn py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200">Male MPs</button>
                    <button id="female-tab" data-view="female" class="tab-btn py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200">Female MPs</button>
                </nav>
            </div>

            <div id="controls-section" class="hidden my-4 p-4 bg-slate-800/50 rounded-lg">
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
                    <h3 class="text-sm font-bold text-slate-400 uppercase">View Range:</h3>
                    <div class="flex gap-2 items-center">
                        <select id="start-date-select" class="p-2 bg-slate-700 border border-slate-600 rounded-lg text-sm"></select>
                        <span>to</span>
                        <select id="end-date-select" class="p-2 bg-slate-700 border border-slate-600 rounded-lg text-sm"></select>
                    </div>
                    <div class="flex gap-2 sm:ml-auto">
                        <button id="filter-btn" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-500 transition-colors">Apply</button>
                        <button id="export-btn" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-500 transition-colors">Export CSV</button>
                    </div>
                </div>
            </div>

            <div id="table-container" class="overflow-x-auto rounded-lg border border-slate-700 min-h-[300px]">
                <div id="placeholder" class="text-center text-slate-500 py-20 font-medium">Please wait, analyzing data...</div>
            </div>
        </div>
    </main>

    <!-- Details Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center p-4 border-b border-slate-700">
                <h3 id="modal-title" class="text-lg font-bold gradient-text"></h3>
                <button id="modal-close-btn" class="text-slate-400 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-4 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const elements = {
            homepage: document.getElementById('homepage-view'),
            dashboard: document.getElementById('dashboard-view'),
            fileInput: document.getElementById('file-upload'),
            dropZone: document.getElementById('drop-zone'),
            table: document.getElementById('table-container'),
            rosterSelect: document.getElementById('roster-date-select'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            startSelect: document.getElementById('start-date-select'),
            endSelect: document.getElementById('end-date-select')
        };

        let fullData = { all: [], male: [], female: [], headers: [], allHeaders: [], dateMap: {} };
        let currentView = 'all';

        elements.dropZone.onclick = () => elements.fileInput.click();
        elements.fileInput.onchange = (e) => processFile(e.target.files[0]);

        function processFile(file) {
            if (!file) return;
            elements.homepage.classList.add('hidden');
            elements.dashboard.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                handleWorkbook(workbook);
            };
            reader.readAsArrayBuffer(file);
        }

        function findHeaderRow(ws) {
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row.some(cell => String(cell).includes("Employee Name") || String(cell).includes("Emp Id"))) {
                    return i;
                }
            }
            return 0; // Fallback
        }

        function handleWorkbook(wb) {
            const possibleSheetNames = { male: ['Hub MP', 'HUB'], female: ['Processing MP', 'Processing'] };
            let combined = [];
            let headerDates = new Map();

            wb.SheetNames.forEach(sheetName => {
                let source = null;
                const cleanName = sheetName.trim().toUpperCase();
                
                if (possibleSheetNames.male.some(n => cleanName === n.toUpperCase())) source = 'male';
                else if (possibleSheetNames.female.some(n => cleanName === n.toUpperCase())) source = 'female';

                if (source) {
                    const ws = wb.Sheets[sheetName];
                    const headerRowIndex = findHeaderRow(ws);
                    const rows = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex, defval: "" });
                    
                    rows.forEach(row => {
                        row._source = source;
                        Object.keys(row).forEach(key => {
                            const dateObj = parseAnyDate(key, headerDates);
                            if (dateObj) headerDates.set(key, dateObj);
                        });
                        combined.push(row);
                    });
                }
            });

            const sortedEntries = Array.from(headerDates.entries()).sort((a, b) => a[1] - b[1]);
            const allHeaders = sortedEntries.map(e => e[0]);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const futureHeaders = sortedEntries
                .filter(e => e[1] >= today)
                .map(e => e[0]);

            fullData = {
                all: combined.filter(r => r['Employee Name'] || r['Emp Id']),
                male: combined.filter(r => r._source === 'male'),
                female: combined.filter(r => r._source === 'female'),
                headers: futureHeaders.length ? futureHeaders : allHeaders,
                allHeaders: allHeaders,
                dateMap: Object.fromEntries(sortedEntries)
            };

            initUI();
        }

        function parseAnyDate(str, existingMap) {
            // Check for ISO
            let d = new Date(str);
            if (!isNaN(d.getTime()) && str.includes("-")) {
                if (d.getFullYear() < 2000) d.setFullYear(2026); // Fix for 2-digit years interpreted as 19xx
                return d;
            }

            // Check for format like "15-Jan"
            const match = str.match(/(\d+)[- \/]([a-zA-Z]+)/) || str.match(/([a-zA-Z]+)[- \/](\d+)/);
            if (match) {
                const monthMap = { jan:0, feb:1, mar:2, apr:3, may:4, jun:5, jul:6, aug:7, sep:8, oct:9, nov:10, dec:11 };
                let day, mStr;
                if (!isNaN(match[1])) { day = parseInt(match[1]); mStr = match[2]; }
                else { day = parseInt(match[2]); mStr = match[1]; }
                
                const monthIdx = monthMap[mStr.toLowerCase().substring(0,3)];
                if (monthIdx !== undefined) {
                    let year = 2026; // Current Base Year
                    const dates = Array.from(existingMap.values());
                    const lastDate = dates[dates.length - 1];
                    
                    if (lastDate && monthIdx < lastDate.getMonth()) year = lastDate.getFullYear() + 1;
                    else if (lastDate) year = lastDate.getFullYear();
                    
                    return new Date(year, monthIdx, day);
                }
            }
            return null;
        }

        function initUI() {
            populateSelect(elements.rosterSelect, fullData.allHeaders);
            populateSelect(elements.startSelect, fullData.headers);
            populateSelect(elements.endSelect, fullData.headers, true);

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentView = e.target.dataset.view;
                    renderTable(fullData.headers);
                };
            });

            document.getElementById('filter-btn').onclick = () => {
                const start = fullData.headers.indexOf(elements.startSelect.value);
                const end = fullData.headers.indexOf(elements.endSelect.value);
                if (start <= end) renderTable(fullData.headers.slice(start, end + 1));
            };

            document.getElementById('export-btn').onclick = exportCSV;
            elements.rosterSelect.onchange = (e) => renderRosterSummary(e.target.value);
            document.getElementById('modal-close-btn').onclick = () => elements.modal.classList.add('hidden');

            renderRosterSummary(elements.rosterSelect.value);
            renderTable(fullData.headers);
            
            ['legend', 'controls-section', 'tabs-section', 'roster-dashboard'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            });
        }

        function populateSelect(el, items, last = false) {
            el.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
            if (last) el.selectedIndex = Math.max(0, items.length - 1);
        }

        function renderTable(headers) {
            const data = fullData[currentView];
            if (!headers.length || !data.length) {
                elements.table.innerHTML = '<div class="p-10 text-center text-slate-500">No matching roster data found.</div>';
                return;
            }
            let html = `<table class="w-full text-left border-collapse"><thead class="bg-slate-800 sticky top-0"><tr>
                <th class="p-3 text-[10px] uppercase border-b border-slate-700 sticky left-0 bg-slate-800 z-10 w-12">#</th>
                <th class="p-3 text-[10px] uppercase border-b border-slate-700 sticky left-12 bg-slate-800 z-10 w-48">Employee</th>
                <th class="p-3 text-[10px] uppercase border-b border-slate-700 sticky left-60 bg-slate-800 z-10 w-24">ID</th>`;
            headers.forEach(h => html += `<th class="p-3 text-[10px] uppercase text-center border-b border-slate-700 min-w-[70px]">${h}</th>`);
            html += `</tr></thead><tbody>`;
            
            data.forEach((row, i) => {
                html += `<tr class="hover:bg-slate-800/40">
                    <td class="p-3 text-xs border-b border-slate-800 sticky left-0 bg-slate-900 z-10">${i+1}</td>
                    <td class="p-3 text-xs font-semibold border-b border-slate-800 sticky left-12 bg-slate-900 z-10 truncate">${row['Employee Name'] || 'Unknown'}</td>
                    <td class="p-3 text-xs border-b border-slate-800 sticky left-60 bg-slate-900 z-10 font-mono">${row['Emp Id'] || '-'}</td>`;
                headers.forEach(h => {
                    const shift = String(row[h] || '').toUpperCase();
                    const color = shift === 'A' ? 'text-blue-400' : shift === 'B' ? 'text-green-400' : shift === 'C' ? 'text-amber-400' : 'text-slate-500';
                    html += `<td class="p-3 text-xs text-center border-b border-slate-800 font-black ${color}">${shift || '-'}</td>`;
                });
                html += `</tr>`;
            });
            elements.table.innerHTML = html + `</tbody></table>`;
        }

        function renderRosterSummary(date) {
            const counts = { A: [], B: [], C: [] };
            fullData.all.forEach(emp => {
                const shift = String(emp[date] || '').toUpperCase();
                if (counts[shift]) counts[shift].push(emp);
            });
            ['A', 'B', 'C'].forEach(s => {
                const m = counts[s].filter(e => e._source === 'male').length;
                const f = counts[s].filter(e => e._source === 'female').length;
                document.getElementById(`shift-${s.toLowerCase()}-summary`).innerHTML = `
                    <div class="mb-1"><span class="dashboard-filter-btn text-white text-lg" onclick="openDetails('${s}', 'All')">${counts[s].length} Total</span></div>
                    <div class="flex gap-3 text-xs opacity-70">
                        <span class="dashboard-filter-btn" onclick="openDetails('${s}', 'male')">M: ${m}</span>
                        <span class="dashboard-filter-btn" onclick="openDetails('${s}', 'female')">F: ${f}</span>
                    </div>`;
            });
        }

        window.openDetails = (shift, filter) => {
            const date = elements.rosterSelect.value;
            const list = fullData.all.filter(e => String(e[date] || '').toUpperCase() === shift && (filter === 'All' || e._source === filter));
            elements.modalTitle.textContent = `Shift ${shift} - ${date}`;
            elements.modalContent.innerHTML = `<ul class="space-y-1">` + list.map(e => `<li class="flex justify-between text-sm py-2 px-3 bg-slate-700/30 rounded"><span>${e['Employee Name']}</span><span class="opacity-50 font-mono text-xs">${e['Emp Id']}</span></li>`).join('') + `</ul>`;
            elements.modal.classList.remove('hidden');
        };

        function exportCSV() {
            const headers = fullData.headers;
            const rows = [['Employee ID', 'Shift Name', 'Start Date', 'End Date']];
            const shiftMap = { A: '07:00-16:00', B: '13:00-22:00', C: '22:00-07:00' };

            fullData[currentView].forEach(row => {
                let cur = null, start = null;
                headers.forEach((h, i) => {
                    const s = String(row[h] || '').toUpperCase();
                    if (s !== cur) {
                        if (cur && shiftMap[cur]) rows.push([row['Emp Id'], shiftMap[cur], fmt(start), fmt(headers[i-1])]);
                        cur = s; start = h;
                    }
                    if (i === headers.length - 1 && cur && shiftMap[cur]) rows.push([row['Emp Id'], shiftMap[cur], fmt(start), fmt(h)]);
                });
            });

            const blob = new Blob([rows.map(r => r.join(',')).join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Export_${currentView}.csv`;
            link.click();
        }

        function fmt(h) {
            const d = fullData.dateMap[h];
            if (!d) return h;
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return `${d.getDate()}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }
    </script>
</body>
</html>
